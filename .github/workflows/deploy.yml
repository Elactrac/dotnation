name: Deploy to Network

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Target network'
        required: true
        default: 'rococo'
        type: choice
        options:
          - rococo
          - shibuya
          - astar
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-contract:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: wasm32-unknown-unknown
    
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install cargo-contract
      run: cargo install cargo-contract --version 5.0.3 --force
    
    - name: Run contract tests
      working-directory: ./donation_platform
      run: cargo test

    - name: Build contract (release)
      working-directory: ./donation_platform
      run: cargo contract build --release
    
    - name: Upload contract for deployment
      uses: actions/upload-artifact@v4
      with:
        name: contract-deployment-${{ github.event.inputs.network }}-${{ github.run_number }}
        path: |
          donation_platform/target/ink/donation_platform.contract
          donation_platform/target/ink/donation_platform.json
        retention-days: 90
    
    - name: Display deployment info
      working-directory: ./donation_platform
      run: |
        echo "‚úÖ Contract built successfully"
        echo "üì¶ Artifact: target/ink/donation_platform.contract"
        echo "üåê Target network: ${{ github.event.inputs.network }}"
        echo "üîê Environment: ${{ github.event.inputs.environment }}"
        echo ""
        echo "‚ö†Ô∏è  Manual deployment required:"
        echo "1. Go to https://polkadot.js.org/apps/"
        echo "2. Connect to the target network"
        echo "3. Upload contract file from artifacts"
        echo "4. Save the contract address"
        echo "5. Update VITE_CONTRACT_ADDRESS secret"
  
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-contract
    # Frontend can be deployed independently, contract address set via secrets
    
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4 # can pin to a specific tag/SHA for stability
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Copy .env.example to .env if .env doesn't exist
      working-directory: ./frontend
      run: |
        if [ ! -f .env ]; then
          cp .env.example .env
          echo "Created .env from .env.example"
        fi

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Run frontend tests
      working-directory: ./frontend
      run: npm test -- --run || echo "No tests configured"
      continue-on-error: true
    
    - name: Build with environment config
      working-directory: ./frontend
      env:
        VITE_NETWORK_NAME: ${{ github.event.inputs.network }}
        VITE_RPC_ENDPOINT: ${{ secrets[format('VITE_RPC_ENDPOINT_{0}', github.event.inputs.network)] }}
        VITE_CONTRACT_ADDRESS: ${{ secrets[format('VITE_CONTRACT_ADDRESS_{0}', github.event.inputs.network)] }}
      run: npm run build
    

    - name: Upload frontend build
      uses: actions/upload-artifact@v4
      with:
        name: frontend-deployment-${{ github.event.inputs.network }}-${{ github.run_number }}
        path: frontend/dist/
        retention-days: 90
    
    - name: Display deployment instructions
      run: |
        echo "‚úÖ Frontend built successfully"
        echo "üì¶ Artifacts uploaded"
        echo ""
        echo "üìù To complete deployment:"
        echo "1. Download the frontend-deployment artifact"
        echo "2. Deploy to your hosting platform (Vercel, Netlify, etc.)"
        echo "   - Vercel: vercel --prod"
        echo "   - Netlify: netlify deploy --prod --dir=dist"
        echo "   - IPFS: ipfs add -r dist/"
  
  deploy-backend:
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: gemini-backend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./gemini-backend
      run: npm ci
    
    - name: Create .env file
      working-directory: ./gemini-backend
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "GEMINI_API_KEY=$GEMINI_API_KEY" > .env
        echo "PORT=3001" >> .env
    
    - name: Test server startup
      working-directory: ./gemini-backend
      run: |
        timeout 5s node server.js || echo "Server started successfully"
    
    - name: Upload backend for deployment
      uses: actions/upload-artifact@v4
      with:
        name: backend-deployment-${{ github.run_number }}
        path: |
          gemini-backend/
          !gemini-backend/node_modules
          !gemini-backend/.env
        retention-days: 90
    
    - name: Display backend deployment instructions
      run: |
        echo "‚úÖ Backend ready for deployment"
        echo ""
        echo "üìù Deployment options:"
        echo "1. Deploy to Railway: railway up"
        echo "2. Deploy to Render: render deploy"
        echo "3. Deploy to Fly.io: fly deploy"
        echo "4. Deploy to Heroku: git push heroku main"
        echo ""
        echo "‚ö†Ô∏è  Remember to set GEMINI_API_KEY environment variable on your platform"
