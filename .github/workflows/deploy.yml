name: Deploy to Network

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Target network'
        required: true
        default: 'rococo'
        type: choice
        options:
          - rococo
          - shibuya
          - astar
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-contract:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: wasm32-unknown-unknown
    
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install cargo-contract
      run: cargo install cargo-contract --version 5.0.3 --force
    
    - name: Run contract tests
      working-directory: ./donation_platform
      run: cargo test

    - name: Build contract (release)
      working-directory: ./donation_platform
      run: cargo contract build --release
    
    - name: Upload contract for deployment
      uses: actions/upload-artifact@v4
      with:
        name: contract-deployment-${{ github.event.inputs.network }}-${{ github.run_number }}
    - name: Display deployment info
      working-directory: ./donation_platform
      run: |
        echo "‚úÖ Contract built successfully"
        echo "üì¶ Artifact: target/ink/donation_platform.contract"
        echo "üåê Target network: ${{ github.event.inputs.network }}"
        echo "üîê Environment: ${{ github.event.inputs.environment }}"
        echo ""
        echo "‚ö†Ô∏è  Manual deployment required:"
        echo "1. Go to https://polkadot.js.org/apps/"
        echo "2. Connect to the target network"
        echo "3. Upload contract file from artifacts"
        echo "4. Save the contract address"
        echo "5. Update VITE_CONTRACT_ADDRESS secret"
          donation_platform/target/ink/donation_platform.json
        retention-days: 90
  
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-contract
    if: ${{ vars.VITE_CONTRACT_ADDRESS != '' }}
    

    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4 # can pin to a specific tag/SHA for stability
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Copy .env.example to .env if .env doesn't exist
      working-directory: ./frontend
      run: |
        if [ ! -f .env ]; then
          cp .env.example .env
          echo "Created .env from .env.example"
        fi

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Run frontend tests
      working-directory: ./frontend
      run: npm test

    - name: Build with environment config
      working-directory: ./frontend
      run: npm run build
    

    - name: Upload frontend build
      uses: actions/upload-artifact@v4
      with:
        name: frontend-deployment-${{ github.event.inputs.network }}-${{ github.run_number }}
        path: frontend/dist/
        retention-days: 90
    
    - name: Display deployment instructions
      run: |
        echo "‚úÖ Frontend built successfully"
        echo "üì¶ Artifacts uploaded"
        echo ""
        echo "üìù To complete deployment:"
        echo "1. Download the frontend-deployment artifact"
        echo "2. Deploy to your hosting platform (Vercel, Netlify, etc.)"
        echo "   - Vercel: vercel --prod"
        echo "   - Netlify: netlify deploy --prod --dir=dist"
        echo "   - IPFS: ipfs add -r dist/"
